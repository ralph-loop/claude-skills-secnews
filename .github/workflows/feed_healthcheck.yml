name: Feed Healthcheck

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # Runs weekly on Sunday at midnight UTC

permissions:
  contents: read
  issues: write

jobs:
  test-feeds:
    runs-on: ubuntu-latest
    outputs:
      test_failed: ${{ steps.run_tests.outcome == 'failure' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m venv .venv
          .venv/bin/pip install -r requirements.txt

      - name: Run Feed URL tests
        id: run_tests
        continue-on-error: true
        run: .venv/bin/pytest -n auto --junitxml=report.xml

      - name: Upload test report
        if: steps.run_tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: report.xml

  create-remediation-issue:
    runs-on: ubuntu-latest
    needs: test-feeds
    if: needs.test-feeds.outputs.test_failed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download test report
        uses: actions/download-artifact@v4
        with:
          name: test-report

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Parse failed URLs and create issue body
        id: parse_failures
        run: python .github/scripts/parse_report.py

      - name: Create GitHub Issue
        if: steps.parse_failures.outputs.has_failures == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ steps.parse_failures.outputs.issue_body }}
        run: |
          # Check for existing open issue with same title
          existing=$(gh issue list --state open --search "Remediate Broken SecNews Feed URLs" --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -n "$existing" ]; then
            echo "Updating existing issue #$existing"
            gh issue comment "$existing" --body "$ISSUE_BODY"
          else
            gh issue create \
              --title "Remediate Broken SecNews Feed URLs" \
              --body "$ISSUE_BODY" \
              --label "bug"
          fi
